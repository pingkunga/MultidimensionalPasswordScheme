(function(a){a.widget("ui.pattern",a.ui.mouse,{widgetEventPrefix:"pattern",options:{arrowCorrectImage:"",arrowIncorrectImage:"",clearDelay:2000,gridSize:3,lineColor:"#fff",lineOpacity:0.3,lineWidth:45,multiSelect:false,showPattern:true},_create:function(){var b;this.element.addClass("ui-pattern ui-widget");if(this.options.disabled===true){this.element.addClass("ui-state-disabled")}else{this.element.addClass("ui-state-default")}b=a("<canvas></canvas>");if(b&&b[0].getContext){b.addClass("ui-patter-line-container").css({opacity:this.options.lineOpacity}).appendTo(this.element);this._linecontainer=b;this._canvasSupported=true}this._nodecontainer=a("<div></div>").addClass("ui-patter-node-container").appendTo(this.element);if(this._canvasSupported===true){this._arrowcontainer=a("<canvas></canvas>").addClass("ui-patter-arrow-container").appendTo(this.element)}this._pattern=[];this._cachedCoordinates=[];this._timer=null;this._previousNode=null;this._createGrid();this._setArrowCorrect();this._setArrowIncorrect();this.options.distance=0;this._mouseInit()},destroy:function(){this.element.unbind("."+this.widgetName).removeClass("ui-pattern ui-widget ui-state-default ui-state-disabled").children().remove();this._mouseDestroy();return this},_setOption:function(b,c){a.Widget.prototype._setOption.apply(this,arguments);switch(b){case"lineOpacity":if(this._canvasSupported===true){this._linecontainer.css("opacity",this.options.lineOpacity)}break;case"gridSize":this._clear();this._createGrid();break;case"disabled":if(c===true){this._clear();this.element.addClass("ui-state-disabled").removeClass("ui-state-default")}else{this.element.addClass("ui-state-default").removeClass("ui-state-disabled")}break;case"arrowCorrectImage":this._setArrowCorrect();break;case"arrowIncorrectImage":this._setArrowIncorrect();break}},_mouseDrag:function(d){var c,b=this;if(this._started!==true){return false}c=this.element.find(".ui-pattern-node").filter(function(){return this!==b._previousNode[0]&&(b.options.multiSelect===true||a(this).attr("selected")!=="selected")}).hitTest(d.pageX-this._nodecontainer.offset().left,d.pageY-this._nodecontainer.offset().top);if(c.length){this._selectNode(a(c[0]),d)}if(this.options.showPattern===true){this._drawLines(d)}return false},_mouseStart:function(c){var b;if(this.options.disabled===true||this._waitingForClear===true){return false}b=this.element.find(".ui-pattern-node").hitTest(c.pageX-this._nodecontainer.offset().left,c.pageY-this._nodecontainer.offset().top);if(b.length){this._start();this._selectNode(a(b[0]),c)}return true},_mouseStop:function(b){this._stop(b)},_clear:function(){if(this._timer!==null){clearTimeout(this._timer);this._timer=null}this._started=false;this._waitingForClear=false;this._pattern=[];this._cachedCoordinates=[];this._previousNode=null;this.element.find(".ui-pattern-node").filter(function(){return a(this).attr("selected")==="selected"}).removeClass("ui-pattern-selected ui-pattern-correct ui-pattern-incorrect").removeAttr("selected");this._clearLines();this._clearArrows();this._setCanvasWidth()},_clearArrows:function(){var b;if(this._canvasSupported!==true){return}b=this._arrowcontainer[0].getContext("2d");b.clearRect(0,0,this._arrowcontainer[0].width,this._arrowcontainer[0].height)},_clearLines:function(){var b;if(this._canvasSupported!==true){return}b=this._linecontainer[0].getContext("2d");b.clearRect(0,0,this._linecontainer[0].width,this._linecontainer[0].height)},_createGrid:function(){var d,b,c;this._nodecontainer.children().remove();for(d=0;d<this.options.gridSize;d++){c=a("<div></div>").addClass("ui-pattern-row");for(b=0;b<this.options.gridSize;b++){this._createNode(b,d).appendTo(c)}this._nodecontainer.append(c)}},_createNode:function(b,d){var c=this;return a("<a></a>").attr("href","#").data("x.ui-pattern-node",b).data("y.ui-pattern-node",d).addClass("ui-pattern-node").click(function(e){e.preventDefault()}).hover(function(){if(c.options.disabled!==true){a(this).addClass("ui-state-hover")}},function(){a(this).removeClass("ui-state-hover")}).focus(function(){if(c.options.disabled!==true){a(".ui-pattern-node .ui-state-focus").removeClass("ui-state-focus");a(this).addClass("ui-state-focus")}else{a(this).blur()}}).blur(function(){a(this).removeClass("ui-state-focus")}).keydown(function(g){var f,i,h=parseInt(a(this).data("x.ui-pattern-node"),10),e=parseInt(a(this).data("y.ui-pattern-node"),10);if(g.keyCode===a.ui.keyCode.UP){if(e>0){f=c.element.find(".ui-pattern-node").filter(function(){return parseInt(a(this).data("x.ui-pattern-node"),10)===h&&parseInt(a(this).data("y.ui-pattern-node"),10)===e-1});f.focus();g.preventDefault()}}else{if(g.keyCode===a.ui.keyCode.DOWN){if(e<c.options.gridSize-1){f=c.element.find(".ui-pattern-node").filter(function(){return parseInt(a(this).data("x.ui-pattern-node"),10)===h&&parseInt(a(this).data("y.ui-pattern-node"),10)===e+1});f.focus();g.preventDefault()}}else{if(g.keyCode===a.ui.keyCode.LEFT){if(h>0){f=c.element.find(".ui-pattern-node").filter(function(){return parseInt(a(this).data("x.ui-pattern-node"),10)===h-1&&parseInt(a(this).data("y.ui-pattern-node"),10)===e});f.focus();g.preventDefault()}}else{if(g.keyCode===a.ui.keyCode.RIGHT){if(h<c.options.gridSize-1){f=c.element.find(".ui-pattern-node").filter(function(){return parseInt(a(this).data("x.ui-pattern-node"),10)===h+1&&parseInt(a(this).data("y.ui-pattern-node"),10)===e});f.focus();g.preventDefault()}}else{if(g.keyCode===a.ui.keyCode.SPACE){if(c.options.disabled===true||c._waitingForClear===true){return}i=c.element.find(".ui-pattern-node").filter(function(){return a(this).attr("selected")==="selected"});if(!i.length){c._start()}if((!c._previousNode||this!==c._previousNode[0])&&(c.options.multiSelect===true||a(this).attr("selected")!=="selected")){c._selectNode(a(this),g);if(c.options.showPattern===true){c._drawLines(null)}g.preventDefault()}}else{if(g.keyCode===a.ui.keyCode.ENTER){if(c.options.disabled===true||c._waitingForClear===true){return}i=c.element.find(".ui-pattern-node").filter(function(){return a(this).attr("selected")==="selected"});if(i.length){c._stop(g)}}}}}}}})},_drawArrow:function(i,h,c){var d,e,b=h.x-i.x,g=h.y-i.y,f=-Math.atan2(-b,-g);if(this._canvasSupported!==true){return}if((c===null||c===undefined)||(c===true&&this._arrowCorrect===null)||(c===false&&this._arrowIncorrect===null)){return}d=this._arrowcontainer[0].getContext("2d");if(c===true){e=a(this._arrowCorrect)}else{e=a(this._arrowIncorrect)}d.translate(i.x,i.y);d.rotate(f);d.drawImage(e[0],-(e.attr("width")/2),-(e.attr("height")/2));d.rotate(-f);d.translate(-i.x,-i.y)},_drawArrows:function(b){var c;if(this._canvasSupported!==true){return}this._clearArrows();if((b===null||b===undefined)||(b===true&&this._arrowCorrect===null)||(b===false&&this._arrowIncorrect===null)){return}for(c=1;c<this._cachedCoordinates.length;c++){this._drawArrow(this._cachedCoordinates[c-1],this._cachedCoordinates[c],b)}},_drawLines:function(e){var c,b,d,f;if(this._canvasSupported!==true){return}this._clearLines();if(!this._cachedCoordinates.length){return}c=this._linecontainer[0].getContext("2d");c.beginPath();for(b=1;b<this._cachedCoordinates.length;b++){d=this._cachedCoordinates[b-1];f=this._cachedCoordinates[b];c.moveTo(d.x,d.y);c.lineTo(f.x,f.y)}if(e){c.moveTo(this._cachedCoordinates[this._cachedCoordinates.length-1].x,this._cachedCoordinates[this._cachedCoordinates.length-1].y);c.lineTo(e.pageX-this._linecontainer.offset().left,e.pageY-this._linecontainer.offset().top)}c.lineCap="round";c.lineJoin="round";c.lineWidth=this.options.lineWidth;c.strokeStyle=this.options.lineColor;c.stroke();c.closePath()},_getNode:function(b,f,d,c){var e;b+=d;f+=c;e=this.element.find(".ui-pattern-node").filter(function(){return parseInt(a(this).data("x.ui-pattern-node"),10)===b&&parseInt(a(this).data("y.ui-pattern-node"),10)===f});if(this.options.multiSelect!==true&&e.attr("selected")==="selected"){return this._getNode(b,f,d,c)}else{return e}},_selectNode:function(h,g){var e,c,b,d=this._previousNode,i=parseInt(h.data("x.ui-pattern-node"),10),f=parseInt(h.data("y.ui-pattern-node"),10);if(d!==null){e=parseInt(d.data("x.ui-pattern-node"),10);c=parseInt(d.data("y.ui-pattern-node"),10);if(i===e){if(f>c){b=this._getNode(i,c,0,1)}else{b=this._getNode(i,c,0,-1)}}else{if(f===c){if(i>e){b=this._getNode(e,f,1,0)}else{b=this._getNode(e,f,-1,0)}}else{if(f-i===c-e){if(f>c){b=this._getNode(e,c,1,1)}else{b=this._getNode(e,c,-1,-1)}}else{if(f+i===c+e){if(i>e){b=this._getNode(e,c,1,-1)}else{b=this._getNode(e,c,-1,1)}}}}}if(b&&b[0]!==h[0]){this._selectNode(b,g)}}if(d!==this._previousNode){this._selectNode(h,g);return}this._previousNode=h;h.attr("selected","selected");this._pattern.push(f*this.options.gridSize+i+1);if(this.options.showPattern===true){h.addClass("ui-pattern-selected")}if(this._cachedCoordinates.length){if(this.options.showPattern===true){this._drawArrow(this._cachedCoordinates[this._cachedCoordinates.length-1],{x:h.position().left+(h.outerWidth(true)/2),y:h.position().top+(h.outerHeight(true)/2)},true)}}this._cachedCoordinates.push({x:h.position().left+(h.outerWidth(true)/2),y:h.position().top+(h.outerHeight(true)/2)});this._trigger("change",g,{pattern:this._pattern})},_setArrowCorrect:function(){if(this.options.arrowCorrectImage!==null&&this.options.arrowCorrectImage!==undefined){this._arrowCorrect=a("<img/>").attr("src",this.options.arrowCorrectImage)}else{this._arrowCorrect=null}},_setArrowIncorrect:function(){if(this.options.arrowIncorrectImage!==null&&this.options.arrowIncorrectImage!==undefined){this._arrowIncorrect=a("<img/>").attr("src",this.options.arrowIncorrectImage)}else{this._arrowIncorrect=null}},_setCanvasWidth:function(){var c,d=0,b=0;if(this._canvasSupported!==true){return}c=this.element.find(".ui-pattern-node");if(c.length){d=a(c[0]).outerWidth(true)*this.options.gridSize;b=a(c[0]).outerHeight(true)*this.options.gridSize}this._arrowcontainer[0].width=this._linecontainer[0].width=d;this._arrowcontainer[0].height=this._linecontainer[0].height=b},_start:function(b){this._clear();this._trigger("start",b);this._started=true},_stop:function(b){this._waitingForClear=true;this._started=false;if(this.options.showPattern===true){this._drawLines()}this._trigger("stop",b,{pattern:this._pattern})},clearPattern:function(c){var d,b=this;this._waitingForClear=false;if(c===false||this.options.showPattern===true){if(c===true){d="ui-pattern-correct"}else{d="ui-pattern-incorrect"}this.element.find(".ui-pattern-node").filter(function(){return a(this).attr("selected")==="selected"}).removeClass("ui-pattern-selected").addClass(d);this._drawLines();this._drawArrows(c)}this._cachedCoordinates=[];this._timer=setTimeout(function(){if(b._started!==true){b._clear()}},this.options.clearDelay)},pattern:function(){return this._pattern}});a.extend(a.ui.pattern,{version:"@VERSION"});a.fn.hitTest=function(c,d){var b=[];this.each(function(){var e=a(this).position(),g=parseInt(a(this).css("margin-left"),10)||0,f=parseInt(a(this).css("margin-top"),10)||0;if(e.left+g<=c&&e.left+g+a(this).outerWidth()>=c&&e.top+f<=d&&e.top+f+a(this).outerHeight()>=d){b.push(this)}});return b}})(jQuery);